#Install and configure NRPE for Nagios monitoring

   - name: Install Prerequisites
     apt:
       name:
        - autoconf
        - automake
        - gcc
        - libc6
        - libmcrypt-dev
        - make
        - libssl-dev
        - wget
        - openssl

   - name: Source Download
     raw: cd /tmp && wget --no-check-certificate -O nrpe.tar.gz https://github.com/NagiosEnterprises/nrpe/archive/nrpe-3.2.1.tar.gz && tar xzf nrpe.tar.gz

   - name: Configure
     raw: cd /tmp/nrpe-nrpe-3.2.1 && ./configure --enable-command-args --with-ssl-lib=/usr/lib/x86_64-linux-gnu/

   - name: Make
     make:
       chdir: /tmp/nrpe-nrpe-3.2.1/
       target: all

   - name: Make install-group-users
     make:
       chdir: /tmp/nrpe-nrpe-3.2.1/
       target: install-groups-users

   - name: Make install
     make:
       chdir: /tmp/nrpe-nrpe-3.2.1/
       target: install

   - name: Make install-config
     make:
       chdir: /tmp/nrpe-nrpe-3.2.1/
       target: install-config

   - name: Update /etc/services
     raw: sh -c "echo >> /etc/services" &&  sh -c "sudo echo '# Nagios services' >> /etc/services" && sh -c "sudo echo 'nrpe    5666/tcp' >> /etc/services"

   - name: Make install-init
     make:
       chdir: /tmp/nrpe-nrpe-3.2.1/
       target: install-init

   - name: Enable nrpe
     service:
       name: nrpe
       service: enable

   - name: Create /etc/ufw/applications.d directory
     file:
       path: /etc/ufw/applications.d
       state: directory

   - name: Edit ufw config
     raw: sh -c "echo '[NRPE]' > /etc/ufw/applications.d/nagios" && sh -c "echo 'title=Nagios Remote Plugin Executor' >> /etc/ufw/applications.d/nagios" && sh -c "echo 'description=Allows remote execution of Nagios plugins' >> /etc/ufw/applications.d/nagios" && sh -c "echo 'ports=5666/tcp' >> /etc/ufw/applications.d/nagios"

   - ufw:
       rule: allow
       name: NRPE

   - name: Copy nrpe Template
     copy:
       src: /home/carson/ansiblePlays/templates/nrpe.cfg
       dest: /usr/local/nagios/etc/nrpe.cfg

   - name: Start nrpe
     service:
       name: nrpe
       state: started
